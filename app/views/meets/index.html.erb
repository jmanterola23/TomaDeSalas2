<h1>Reuniones para <%= @room.name %></h1>

<!-- Input oculto para almacenar el ID del Meet -->
<input type="hidden" id="meet_id" value="">

<!-- Elemento para mostrar la capacidad disponible -->
<div id="availableCapacity"></div>

<div id="meets_container" class="list-group">
  <% if @meets.present? %>
    <% @meets.each do |meet| %>
      <div class="list-group-item">
        <h2>Reunión: <%= meet.description %></h2>
        <p>Hora: <%= meet.hour.getlocal.strftime("%H:%M") %></p>
        <% if meet.reserved %>
          <p>Esta reunión ya está reservada.</p>
          <%= button_to 'Eliminar Reserva', cancel_reservation_room_meet_path(@room, meet), method: :post, class: "btn btn-danger" %>
        <% else %>
          <%= button_to 'Reservar', '#', 
                class: "btn btn-success", 
                data: { 
                  toggle: "modal", 
                  target: "#reservationModal", 
                  room_id: @room.id, 
                  meet_id: meet.id, 
                  available_capacity: @room.capacity - (meet.participants_count || 0) 
                } %>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <p>No hay reuniones disponibles para esta sala.</p>
  <% end %>
</div>

<!-- Modal -->
<div class="modal fade" id="reservationModal" tabindex="-1" role="dialog" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">Reservar Reunión</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="availableCapacity"></p> <!-- Mostrar capacidad disponible -->
        <p id="participantsCount"></p> <!-- Mostrar número de participantes -->
        <%= form_with(url: reserve_room_meet_path(@room, 'meet_id_placeholder'), method: :post, id: 'reservationForm') do |form| %>
          <div class="mb-3">
            <%= form.label :participants, "Número de participantes" %>
            <%= form.number_field :participants, min: 1, required: true, class: "form-control" %>
          </div>
          <%= form.submit "Reservar", class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Incluye jQuery y Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
document.addEventListener('turbo:load', function() {
    document.querySelectorAll('.btn-success').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();

            const meetId = this.getAttribute('data-meet-id');
            const availableCapacity = this.getAttribute('data-available-capacity');
            const participantsCount = this.getAttribute('data-participants-count'); // Asegúrate de tener este dato

            // Rellenar el modal con los datos
            document.getElementById('meet_id').value = meetId;
            document.getElementById('availableCapacity').textContent = `Capacidad disponible: ${availableCapacity}`;
            document.getElementById('participantsCount').textContent = `Número de participantes actuales: ${participantsCount}`; // Actualiza el número de participantes

            // Abrir el modal
            $('#reservationModal').modal('show');
        });
    });
});
</script>
